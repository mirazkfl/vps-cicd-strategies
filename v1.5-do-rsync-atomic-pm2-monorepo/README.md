# ‚öõÔ∏è Monorepo Atomic Deployment Pipeline (Version 1.5)

This deployment strategy is designed for **monorepos** containing multiple Next.js applications with **atomic symlink deployments** for zero downtime and instant rollbacks.

**Strategy:** Local Build ‚Üí Filtered Build ‚Üí Atomic Release Upload ‚Üí Symlink Switch ‚Üí PM2 Reload.

## üéØ Why Atomic Monorepo?

1. **Path-Based Filtering:** Only deploys the app that changed
2. **Atomic Deployments:** Each app gets timestamped releases with instant rollback capability
3. **Zero Downtime:** Symlink switching ensures no broken deployments
4. **Multiple Apps:** Each app has isolated releases (`/home/deploy/apps/web/releases/`, `/home/deploy/apps/admin/releases/`)

## üìã Prerequisites

### Next.js Configuration

Your Next.js apps **must** be configured for standalone output:

**File:** `apps/web/next.config.js` (or `apps/web/next.config.mjs`)

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone', // REQUIRED for this deployment strategy
  // ... other config
};

module.exports = nextConfig;
```

### Package.json Scripts

Each app in your monorepo needs a build script:

**File:** `package.json` (root or workspace)

```json
{
  "scripts": {
    "build": "next build",
    "start": "next start"
  },
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
}
```

**File:** `apps/admin/package.json`

```json
{
  "name": "admin",
  "scripts": {
    "build": "next build"
  }
}
```

## üìÇ Folder Architecture (On Server)

```
/home/deploy/apps/
‚îú‚îÄ‚îÄ web/
‚îÇ   ‚îú‚îÄ‚îÄ releases/                <-- Stores all web app versions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 202512291000/        <-- Old Release
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 202512291100/        <-- Current Active Code
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 202512291200/        <-- Incoming Upload
‚îÇ   ‚îú‚îÄ‚îÄ current -> releases/202512291100  <-- Symlink (Nginx points here)
‚îÇ   ‚îî‚îÄ‚îÄ scripts/
‚îÇ       ‚îî‚îÄ‚îÄ atomic_switch.sh       <-- Script that flips the link
‚îî‚îÄ‚îÄ admin/
    ‚îú‚îÄ‚îÄ releases/                <-- Stores all admin app versions
    ‚îÇ   ‚îú‚îÄ‚îÄ 202512291000/
    ‚îÇ   ‚îî‚îÄ‚îÄ 202512291100/
    ‚îú‚îÄ‚îÄ current -> releases/202512291100
    ‚îî‚îÄ‚îÄ scripts/
        ‚îî‚îÄ‚îÄ atomic_switch.sh
```

## üõ†Ô∏è Setup Instructions

### 1. Server Setup (Run Once Per Server)

1. SSH into your server as root: `ssh root@your_ip`
2. Copy the setup script: `nano setup_monorepo.sh`
3. Paste the content of `setup_monorepo.sh`
4. Run it: `bash setup_monorepo.sh`
5. When prompted:
   - Enter deploy username (e.g., `deploy`)
   - Enter Node.js version (default: 20)
   - **First app setup:** Enter app name (e.g., `admin`), domain, and port
6. **Critical:** Copy the `SSH_PRIVATE_KEY` printed at the end

### 2. Setup Additional Apps

Run `setup_monorepo.sh` again for each app:
- App name: `web`
- Domain: `app.example.com`
- Port: `3000` (different from admin)

The script creates separate atomic deployment structures for each app.

### 3. GitHub Secrets

Go to **Settings > Secrets and variables > Actions** and add:

| Secret Name | Value |
|-------------|-------|
| `DROPLET_IP` | Your server's IP address |
| `DROPLET_USER` | The username you chose (e.g., `deploy`) |
| `SSH_PRIVATE_KEY` | The private key generated by the script |
| `NEXT_PUBLIC_API_URL` | Your production API URL |

### 4. App-Specific Configuration

#### Ecosystem Config

Each app needs its own `ecosystem.config.js` file:

**File:** `apps/admin/ecosystem.config.js`

```javascript
module.exports = {
    apps: [{
        name: "admin-app", // UNIQUE - must be different for each app
        script: "server.js",
        instances: "1",
        exec_mode: "fork",
        env: {
            NODE_ENV: "production",
            PORT: 3001, // UNIQUE - must match Nginx config
        }
    }]
};
```

**File:** `apps/web/ecosystem.config.js`

```javascript
module.exports = {
    apps: [{
        name: "web-app", // UNIQUE - different from admin-app
        script: "server.js",
        instances: "max",
        exec_mode: "cluster",
        env: {
            NODE_ENV: "production",
            PORT: 3000, // UNIQUE - different from admin
        }
    }]
};
```

#### Workflow Files

Create separate workflow files for each app:

- `.github/workflows/deploy-admin.yml` - Deploys `apps/admin` with atomic strategy
- `.github/workflows/deploy-web.yml` - Deploys `apps/web` with atomic strategy

Each workflow only triggers when its specific app changes.

### 5. Deploying

Simply push to `main`. The pipeline will:
1. Detect which app changed (via path filters)
2. Build only that app
3. Upload to a timestamped release folder
4. Atomically switch the symlink
5. Reload PM2 without downtime

## üõ°Ô∏è Security & Reliability

- **Partial Failure Protection:** If rsync fails mid-transfer, the incomplete release folder doesn't affect the live site (symlink still points to old release)
- **Rollback Capability:** If you deploy a bug, just SSH in and point the symlink back to the previous timestamp folder
- **Zero Downtime:** Symlink switching is atomic - no window where the site is broken
- **Isolated Apps:** Each app has its own release history and can be rolled back independently

## üö® How to Rollback Manually

If a bad deploy happens for a specific app, run this on the server:

```bash
# 1. View available releases for the app
ls -l ~/app/apps/admin/releases

# 2. Point 'current' to the previous timestamp
ln -sfn ~/app/apps/admin/releases/202512291000 ~/app/apps/admin/current

# 3. Reload PM2
cd ~/app/apps/admin/current
pm2 reload ecosystem.config.js
```

## üö® Troubleshooting

### Build Fails: "output: 'standalone' not found"

**Solution:** Ensure `next.config.js` has `output: 'standalone'`

### Port Already in Use

**Solution:** Each app must use a unique port. Check `ecosystem.config.js` and Nginx configs.

### PM2 Process Name Conflict

**Solution:** Ensure each `ecosystem.config.js` has a unique `name` field.

### Symlink Points to Wrong Release

**Solution:** Check that `atomic_switch.sh` exists and is executable: `chmod +x ~/app/apps/{app-name}/scripts/atomic_switch.sh`

